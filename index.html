<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Red Intercultural Juvenil - RIJ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script src="assets/data.js?v=20260218b"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Work+Sans:wght@300;400;500;600;700;800;900&display=swap');
        
        :root {
            --color-primary: #ff6b35;
            --color-secondary: #004e89;
            --color-accent: #f7b801;
            --color-verde: #2a9d8f;
            --color-morado: #6a4c93;
        }

        * {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Work Sans', sans-serif;
            overflow-x: hidden;
        }

        /* Preloader */
        #preloader {
            position: fixed;
            inset: 0;
            z-index: 99999;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000;
            transition: opacity 0.6s ease;
        }
        #preloader.hide {
            opacity: 0;
            pointer-events: none;
        }
        #preloader-bg {
            position: absolute;
            inset: 0;
            background-color: #000;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
        #preloader-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.5);
        }
        #preloader-video {
            position: relative;
            z-index: 2;
            width: 180px;
            height: 180px;
            object-fit: contain;
            filter: drop-shadow(0 0 30px rgba(0,0,0,0.7));
        }
        @media (min-width: 768px) {
            #preloader-video {
                width: 260px;
                height: 260px;
            }
        }

        h1, h2, h3 {
            font-family: 'Work Sans', sans-serif;
            font-weight: 900;
        }

        /* Animación sutil al cargar */
        .fade-in {
            animation: fadeIn 1s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Patrón jaguar para el directorio */
        .jaguar-pattern {
            background-image: 
                radial-gradient(circle at 20% 30%, rgba(0,0,0,0.15) 2%, transparent 3%),
                radial-gradient(circle at 60% 50%, rgba(0,0,0,0.1) 3%, transparent 4%),
                radial-gradient(circle at 35% 70%, rgba(0,0,0,0.12) 2.5%, transparent 3.5%),
                radial-gradient(circle at 80% 20%, rgba(0,0,0,0.08) 2%, transparent 3%),
                radial-gradient(circle at 15% 85%, rgba(0,0,0,0.1) 2.8%, transparent 3.8%);
            background-size: 100px 100px;
            background-color: #f7e7ce;
        }

        /* Divisores orgánicos entre secciones */
        .section-divider {
            position: relative;
            width: 100%;
            height: 0;
            z-index: 10;
            line-height: 0;
            overflow: visible;
        }
        .section-divider svg {
            display: block;
            width: 100%;
            height: 30px;
            position: relative;
        }
        .section-divider.bottom svg {
            margin-bottom: -29px;
        }
        @media (min-width: 768px) {
            .section-divider svg {
                height: 40px;
            }
            .section-divider.bottom svg {
                margin-bottom: -39px;
            }
        }

        /* Secciones con altura completa */
        section {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 3rem 1rem;
            position: relative;
        }

        @media (min-width: 768px) {
            section {
                padding: 4rem 2rem;
            }
        }

        /* Mapa interactivo */
        #map {
            height: 400px;
            width: 100%;
            border-radius: 0;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        @media (min-width: 768px) {
            #map {
                height: 500px;
            }
        }

        @media (min-width: 1024px) {
            #map {
                height: 600px;
            }
        }

        /* Card de organización en mapa */
        .org-popup {
            min-width: 200px;
            max-width: 250px;
            text-align: center;
            padding: 4px 2px;
        }
        .org-popup .popup-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }
        .org-popup .popup-header img {
            width: 40px;
            height: 40px;
            object-fit: contain;
            background: white;
            padding: 3px;
            border-radius: 6px;
            flex-shrink: 0;
        }
        .org-popup .popup-header .popup-title {
            text-align: left;
        }
        .org-popup .popup-header .popup-title h3 {
            font-size: 0.85rem;
            font-weight: 700;
            line-height: 1.15;
            margin: 0;
        }
        .org-popup .popup-header .popup-title p {
            font-size: 0.7rem;
            color: #666;
            margin: 1px 0 0 0;
        }
        .org-popup .popup-details {
            font-size: 0.72rem;
            line-height: 1.3;
            color: #555;
            margin-top: 4px;
            text-align: left;
        }
        .org-popup .popup-details p {
            margin: 1px 0;
        }
        .org-popup .popup-socials {
            display: flex;
            gap: 4px;
            justify-content: center;
            margin-top: 5px;
        }
        .org-popup .popup-socials .social-icon svg {
            width: 18px;
            height: 18px;
        }
        .leaflet-popup-content-wrapper {
            max-height: 55vh;
            overflow-y: auto;
            border-radius: 10px !important;
        }
        .leaflet-popup-content {
            margin: 8px 10px !important;
        }

        @media (max-width: 639px) {
            .org-popup {
                min-width: 180px;
                max-width: 220px;
            }
            .org-popup .popup-header img {
                width: 34px;
                height: 34px;
            }
            .org-popup .popup-header .popup-title h3 {
                font-size: 0.78rem;
            }
            .leaflet-popup-content-wrapper {
                max-height: 45vh;
            }
        }

        /* Franja amarilla de aforismos - flash style */
        .aforismos-banner {
            background-color: var(--color-accent);
            position: fixed;
            left: 0;
            width: 100%;
            z-index: 999;
            box-shadow: none;
            text-align: right;
            padding: 0.6rem 1.5rem;
            min-height: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: flex-end;
            overflow: visible;
        }
        .aforismos-banner::after {
            content: '';
            position: absolute;
            bottom: -6px;
            left: 0;
            width: 100%;
            height: 6px;
            background: var(--color-accent);
            mask-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 1200 6' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0,0 Q200,5 400,2 T800,5 T1200,2 L1200,0 Z' fill='black'/%3E%3C/svg%3E");
            -webkit-mask-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 1200 6' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0,0 Q200,5 400,2 T800,5 T1200,2 L1200,0 Z' fill='black'/%3E%3C/svg%3E");
            mask-size: 100% 100%;
            -webkit-mask-size: 100% 100%;
        }

        .aforismo-flash {
            opacity: 0;
            transition: opacity 0.8s ease-in-out;
            text-align: right;
        }

        .aforismo-flash.visible {
            opacity: 1;
        }

        .aforismo-frase {
            font-family: 'Work Sans', sans-serif;
            font-weight: 900;
            font-size: 1.6rem;
            color: #1a1a1a;
            line-height: 1.2;
            letter-spacing: -0.02em;
            text-transform: uppercase;
        }

        .aforismo-org {
            font-family: 'Work Sans', sans-serif;
            font-weight: 400;
            font-size: 0.85rem;
            font-style: italic;
            color: #555;
            margin-top: 0.15rem;
        }

        .aforismo-org::before {
            content: '— ';
        }

        @media (max-width: 639px) {
            .aforismo-frase {
                font-size: 1.15rem;
            }
            .aforismo-org {
                font-size: 0.72rem;
            }
            .aforismos-banner {
                padding: 0.5rem 1rem;
            }
        }

        /* Manifiesto word-by-word scroll */
        #manifiesto {
            display: block;
            padding: 0;
            position: relative;
        }

        .manifiesto-sticky {
            position: sticky;
            /* top se establece vía JS para quedar justo debajo del nav+banner */
            display: flex;
            align-items: flex-start;
            justify-content: center;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .manifiesto-content {
            padding: 3rem 0 4rem;
            width: 100%;
        }

        .manifiesto-titulo {
            font-weight: 900;
            font-size: clamp(3rem, 8vw, 6rem);
            text-transform: uppercase;
            letter-spacing: -0.03em;
            line-height: 1.15;
            text-align: center;
            margin-bottom: 1.5rem;
            color: white;
        }

        .manifiesto-titulo .mw {
            opacity: 0;
            transition: opacity 0.25s ease;
        }

        .manifiesto-titulo .mw.vis {
            opacity: 1;
        }

        .manifiesto-cuerpo {
            font-weight: 400;
            font-size: clamp(1.1rem, 2.2vw, 2rem);
            line-height: 1.5;
            text-align: left;
            color: rgba(255, 255, 255, 0.92);
        }

        .manifiesto-cuerpo .mw {
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .manifiesto-cuerpo .mw.vis {
            opacity: 1;
        }

        /* Tarjetas de directorio */
        .org-card {
            background: rgba(255,255,255,0.08);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 1rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
            cursor: pointer;
            display: flex;
            flex-direction: column;
        }

        @media (min-width: 640px) {
            .org-card {
                padding: 1.5rem;
                border-radius: 20px;
            }
        }

        .org-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(255,107,53,0.2);
            border-color: rgba(255,107,53,0.3);
        }

        /* Compact header: logo + info side by side */
        .org-card-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            width: 100%;
        }

        .org-card-header .org-logo {
            width: 56px;
            height: 56px;
            object-fit: contain;
            flex-shrink: 0;
            background: white;
            padding: 2px;
            border-radius: 10px;
            margin: 0;
        }

        @media (min-width: 640px) {
            .org-card-header .org-logo {
                width: 64px;
                height: 64px;
                padding: 3px;
            }
        }

        .org-card-info {
            flex: 1;
            min-width: 0;
        }

        .org-card-info h3 {
            font-size: 0.95rem;
            font-weight: 700;
            line-height: 1.2;
            margin-bottom: 0.15rem;
        }

        .org-card-info .org-location {
            font-size: 0.75rem;
            color: rgba(255,255,255,0.5);
        }

        .org-card-toggle {
            flex-shrink: 0;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
            color: rgba(255,255,255,0.6);
            font-size: 1.2rem;
            font-weight: 300;
            transition: transform 0.3s ease, background 0.3s ease, color 0.3s ease;
            line-height: 1;
        }

        .org-card.expanded .org-card-toggle {
            transform: rotate(45deg);
            background: rgba(255,107,53,0.3);
            color: #ff6b35;
        }

        .org-card-socials {
            display: flex;
            gap: 0.4rem;
            margin-top: 0.35rem;
        }

        .org-card-socials a {
            width: 22px;
            height: 22px;
        }

        /* Collapsible detail section */
        .org-card-detail {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease, opacity 0.3s ease, margin-top 0.3s ease;
            opacity: 0;
            margin-top: 0;
        }

        .org-card.expanded .org-card-detail {
            max-height: 500px;
            opacity: 1;
            margin-top: 0.75rem;
        }

        /* Navegación flotante */
        nav {
            position: fixed;
            top: 0;
            width: 100%;
            background: rgba(255, 107, 53, 0.95);
            backdrop-filter: blur(10px);
            z-index: 1000;
            box-shadow: none;
        }
        nav::after {
            content: '';
            position: absolute;
            bottom: -6px;
            left: 0;
            width: 100%;
            height: 6px;
            background: rgba(255, 107, 53, 0.95);
            mask-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 1200 6' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0,0 Q150,6 300,2 T600,4 T900,1 T1200,3 L1200,0 Z' fill='black'/%3E%3C/svg%3E");
            -webkit-mask-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 1200 6' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0,0 Q150,6 300,2 T600,4 T900,1 T1200,3 L1200,0 Z' fill='black'/%3E%3C/svg%3E");
            mask-size: 100% 100%;
            -webkit-mask-size: 100% 100%;
        }

        /* Asegurar que el botón hamburguesa no se salga */
        nav .nav-inner {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            min-width: 0;
        }

        #menu-toggle {
            flex-shrink: 0;
            padding: 0.5rem;
            margin-left: 0.5rem;
            z-index: 1001;
            color: white;
        }

        nav a {
            color: rgba(255, 255, 255, 0.85);
            transition: color 0.3s ease;
        }

        nav a:hover {
            color: var(--color-accent);
        }

        /* Logo RIJ en nav */
        nav .text-3xl {
            line-height: 1;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        /* Fondo de fotos aleatorias en inicio */
        #inicio {
            position: relative;
            overflow: hidden;
            background-color: #333;
            cursor: pointer;
        }

        /* Estilos para álbumes de galería - Panal hexagonal */
        .honeycomb {
            display: flex;
            flex-direction: column;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        .hex-row {
            display: flex;
            justify-content: center;
            margin-top: -40px;
        }
        .hex-row:first-child {
            margin-top: 0;
        }

        .hex-wrap {
            width: 300px;
            flex-shrink: 0;
            margin: 0 8px;
        }

        @media (max-width: 767px) {
            .honeycomb {
                display: flex;
                flex-direction: column;
                align-items: center;
                padding: 0;
                overflow: hidden;
            }
            .hex-row {
                display: flex;
                justify-content: center;
                margin-top: -18px;
                width: 100%;
                gap: 3px;
            }
            .hex-row:first-child {
                margin-top: 0;
            }
            .hex-wrap {
                width: 42%;
                flex-shrink: 0;
            }
            .hex-row-offset {
                transform: translateX(21.5%);
            }
            .album-card .album-info h3 {
                font-size: 0.82rem;
            }
            .album-card .album-info p {
                font-size: 0.62rem;
            }
        }

        .album-card {
            position: relative;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.3s ease, filter 0.3s ease;
            aspect-ratio: 1 / 1.15;
        }

        .album-card:hover {
            transform: scale(1.08);
            filter: brightness(1.1);
            z-index: 5;
        }

        .album-card .album-bg {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-size: cover;
            background-position: center;
            transition: opacity 2s ease-in-out;
        }

        .album-card .album-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(ellipse at center, rgba(0,0,0,0.5) 0%, rgba(0,0,0,0.15) 70%);
            z-index: 1;
        }

        .album-card .album-info {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 2;
            color: white;
            width: 75%;
        }

        .album-card .album-info h3 {
            font-size: 1.05rem;
            font-weight: 800;
            margin-bottom: 0.3rem;
            text-shadow: 0 2px 6px rgba(0,0,0,0.9);
            line-height: 1.2;
        }

        @media (min-width: 1024px) {
            .album-card .album-info h3 {
                font-size: 1.4rem;
            }
            .album-card .album-info p {
                font-size: 0.85rem;
            }
        }

        .album-card .album-info p {
            font-size: 0.75rem;
            opacity: 0.9;
            text-shadow: 0 1px 4px rgba(0,0,0,0.9);
        }

        /* Modal lightbox */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-image-container {
            position: relative;
            width: 90vw;
            height: 75vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-image-container img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 8px;
            transition: opacity 0.8s ease-in-out;
        }

        .modal-close {
            position: absolute;
            top: 1.5rem; right: 1.5rem;
            color: white;
            font-size: 2.5rem;
            cursor: pointer;
            z-index: 10000;
            background: rgba(255,255,255,0.1);
            width: 50px; height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s;
            border: none;
        }

        .modal-close:hover {
            background: rgba(255,255,255,0.3);
        }

        .modal-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            color: white;
            font-size: 3rem;
            cursor: pointer;
            background: rgba(255,255,255,0.1);
            width: 60px; height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s;
            border: none;
            z-index: 10000;
        }

        .modal-nav:hover {
            background: rgba(255,255,255,0.3);
        }

        .modal-nav.prev { left: 1.5rem; }
        .modal-nav.next { right: 1.5rem; }

        .modal-info {
            color: white;
            text-align: center;
            margin-top: 1rem;
            font-size: 0.9rem;
            opacity: 0.7;
        }

        .modal-album-title {
            color: white;
            text-align: center;
            font-size: 1.5rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
        }

        @media (max-width: 639px) {
            .modal-nav { width: 45px; height: 45px; font-size: 2rem; }
            .modal-nav.prev { left: 0.5rem; }
            .modal-nav.next { right: 0.5rem; }
            .modal-close { top: 0.5rem; right: 0.5rem; width: 40px; height: 40px; font-size: 1.8rem; }
        }

        /* Responsive helpers */
        @media (max-width: 639px) {
            h1 {
                font-size: 2.5rem !important;
                line-height: 1.2;
            }
            h2 {
                font-size: 1.75rem !important;
            }
            .text-6xl {
                font-size: 2.5rem !important;
            }
            .text-8xl {
                font-size: 3rem !important;
            }
            /* Asegurar hamburguesa visible en pantallas estrechas */
            nav .max-w-7xl {
                padding-left: 0.75rem;
                padding-right: 0.75rem;
            }
        }

        /* Mejorar legibilidad en móviles */
        @media (max-width: 767px) {
            body {
                font-size: 0.9rem;
            }
        }

        /* Manifesto mobile optimization */
        @media (max-width: 639px) {
            .manifiesto-titulo {
                font-size: 2.2rem !important;
                margin-bottom: 0.8rem;
            }
            .manifiesto-cuerpo {
                font-size: 0.92rem !important;
                line-height: 1.4;
            }
            .manifiesto-content {
                padding: 1.5rem 0 2rem;
            }
            .manifiesto-sticky {
                overflow-y: hidden;
            }
        }

        /* Orientación horizontal en móviles */
        @media (max-width: 896px) and (max-height: 414px) and (orientation: landscape) {
            section {
                min-height: auto;
                padding: 2rem 1rem;
            }
        }

        /* Filter buttons */
        .filter-btn, .filter-btn-dir {
            padding: 0.35rem 0.9rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            border: 1.5px solid rgba(255,255,255,0.25);
            background: transparent;
            color: rgba(255,255,255,0.7);
            cursor: pointer;
            transition: all 0.2s;
        }
        .filter-btn:hover, .filter-btn-dir:hover {
            border-color: #ff6b35;
            color: #ff6b35;
        }
        .filter-btn.active, .filter-btn-dir.active {
            background: #ff6b35;
            border-color: #ff6b35;
            color: white;
        }

        /* Search results dropdown */
        .search-result-item {
            padding: 0.6rem 1rem;
            cursor: pointer;
            color: white;
            font-size: 0.85rem;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            transition: background 0.15s;
        }
        .search-result-item:hover {
            background: rgba(255,107,53,0.3);
        }
        .search-result-item .sr-name {
            font-weight: 700;
        }
        .search-result-item .sr-loc {
            font-size: 0.7rem;
            opacity: 0.6;
        }

        /* Cluster icon override */
        .marker-cluster-custom {
            background: none !important;
        }
        .cluster-rij {
            width: 52px;
            height: 52px;
            border-radius: 12px;
            background: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            box-shadow: none;
        }
        .cluster-rij img {
            width: 40px;
            height: 40px;
            object-fit: contain;
        }
        .cluster-rij .cluster-count {
            position: absolute;
            bottom: -7px;
            right: -7px;
            background: #ff6b35;
            color: white;
            font-size: 0.72rem;
            font-weight: 800;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 1px 4px rgba(0,0,0,0.3);
        }

        /* Custom org marker */
        .org-marker {
            width: 48px;
            height: 48px;
            border-radius: 10px;
            overflow: visible;
            border: 2.5px solid #ff6b35;
            background: white;
            box-shadow: 0 3px 10px rgba(0,0,0,0.35);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .org-marker img {
            width: 42px;
            height: 42px;
            object-fit: contain;
        }

        /* Social icon SVG links */
        .social-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            transition: transform 0.2s, opacity 0.2s;
            opacity: 0.85;
        }
        .social-icon:hover {
            transform: scale(1.2);
            opacity: 1;
        }
        .social-icon svg {
            width: 20px;
            height: 20px;
            fill: white;
        }
        /* Popup social icons need dark fill */
        .org-popup .popup-socials .social-icon svg {
            fill: #333;
        }

        /* Marquee de logos en footer */
        .logos-marquee {
            overflow: hidden;
            position: relative;
            width: 100%;
            padding: 1.5rem 0;
        }
        .logos-marquee::before, .logos-marquee::after {
            content: '';
            position: absolute;
            top: 0;
            width: 60px;
            height: 100%;
            z-index: 2;
        }
        .logos-marquee::before {
            left: 0;
            background: linear-gradient(to right, #111827, transparent);
        }
        .logos-marquee::after {
            right: 0;
            background: linear-gradient(to left, #111827, transparent);
        }
        .marquee-track {
            display: flex;
            align-items: center;
            gap: 2.5rem;
            animation: marquee-scroll 40s linear infinite;
            width: max-content;
        }
        .marquee-track:hover {
            animation-play-state: paused;
        }
        .marquee-track img {
            height: 50px;
            width: auto;
            max-width: 120px;
            object-fit: contain;
            filter: grayscale(0.3) brightness(1.1);
            transition: filter 0.3s;
            flex-shrink: 0;
        }
        .marquee-track img:hover {
            filter: grayscale(0) brightness(1.2);
        }
        @keyframes marquee-scroll {
            from { transform: translateX(0); }
            to { transform: translateX(-50%); }
        }

        /* Override default cluster styles */
        .leaflet-default-icon-path { display: none; }
        .leaflet-tile-pane {
            filter: saturate(3) hue-rotate(280deg) brightness(0.85) contrast(1.4);
        }
        .marker-cluster div { display: none; }
    </style>
</head>
<body class="bg-white text-gray-900">

    <!-- Preloader -->
    <div id="preloader">
        <div id="preloader-bg"></div>
        <div id="preloader-overlay"></div>
        <video id="preloader-video" autoplay loop muted playsinline>
            <source src="assets/preload/reloj_jaguar.webm" type="video/webm">
        </video>
    </div>

    <!-- Navegación Fija (compacta) -->
    <nav class="py-1" id="main-nav">
        <div class="max-w-7xl mx-auto px-4">
            <div class="nav-inner">
                <div class="flex items-center flex-shrink-0">
                    <img src="assets/logos/RIJ_SIGLA.png?v=20260218" alt="Red Intercultural Juvenil" class="h-12 md:h-16" style="filter: drop-shadow(2px 3px 4px rgba(80, 30, 0, 0.5));">
                </div>
                <ul class="hidden md:flex space-x-5 text-xs font-medium text-white/85">
                    <li><a href="#inicio" class="hover:text-yellow-400">Inicio</a></li>
                    <li><a href="#galeria" class="hover:text-yellow-400">Galería</a></li>
                    <li><a href="#manifiesto" class="hover:text-yellow-400">Manifiesto</a></li>
                    <li><a href="#mapa" class="hover:text-yellow-400">Mapa</a></li>
                    <li><a href="#directorio" class="hover:text-yellow-400">Directorio</a></li>
                    <li><a href="#articulaciones" class="hover:text-yellow-400">Articulaciones</a></li>
                    <li><a href="#salvaguarda" class="hover:text-yellow-400">Salvaguarda</a></li>
                    <li><a href="#envolvente" class="hover:text-yellow-400">Envolvente</a></li>
                    <li><a href="#contacto" class="hover:text-yellow-400">Contacto</a></li>
                </ul>
                <button id="menu-toggle" class="md:hidden">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>
            </div>
        </div>
    </nav>

    <!-- Franja amarilla de aforismos (debajo del nav) -->
    <div class="aforismos-banner" id="aforismos-banner">
        <div class="aforismo-flash" id="aforismo-flash">
            <div class="aforismo-frase" id="aforismo-frase"></div>
            <div class="aforismo-org" id="aforismo-org"></div>
        </div>
    </div>

    <!-- SECCIÓN 1: INTRO/PORTADA CON SLIDESHOW -->
    <section id="inicio" class="h-screen flex items-center justify-center text-white relative overflow-hidden" style="background-color: #333;">
        <!-- Capas de fondo para slideshow con crossfade -->
        <div id="bg-layer-1" style="position:absolute;top:0;left:0;width:100%;height:100%;background-size:cover;background-position:center;background-repeat:no-repeat;z-index:0;opacity:1;transition:opacity 3s ease-in-out;"></div>
        <div id="bg-layer-2" style="position:absolute;top:0;left:0;width:100%;height:100%;background-size:cover;background-position:center;background-repeat:no-repeat;z-index:1;opacity:0;transition:opacity 3s ease-in-out;"></div>
        
        <!-- Contenido sobre el slideshow -->
        <div class="max-w-7xl mx-auto text-center fade-in" style="position:relative;z-index:10;">
            <div class="mb-2 max-w-7xl mx-auto" style="margin-top: -20px;">
                <img src="assets/logos/RIJ_COMP_NEG.png?v=20260218" alt="Red Intercultural Juvenil" class="w-full" style="filter: drop-shadow(3px 5px 8px rgba(80, 30, 0, 0.55));">
            </div>
            <p class="text-lg md:text-3xl font-light max-w-4xl mx-auto mb-6 px-4" style="margin-top: -10px; font-style: italic; text-shadow: 0 0 20px rgba(0,0,0,0.8), 2px 2px 6px rgba(0,0,0,0.6), 0 0 40px rgba(0,0,0,0.4);">
                Tejer identidades para fortalecer el territorio
            </p>
        </div>
    </section>

    <!-- Divider: Inicio → Galería -->
    <div class="section-divider bottom">
        <svg viewBox="0 0 1200 40" preserveAspectRatio="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M0,0 L0,22 Q300,18 600,24 T1200,20 L1200,0 Z" fill="#333"/>
            <path d="M0,22 Q300,18 600,24 T1200,20 L1200,40 L0,40 Z" fill="#facc15"/>
        </svg>
    </div>

    <!-- SECCIÓN 3: GALERÍA -->
    <section id="galeria" class="py-16" style="background-color: #facc15;">
        <div class="max-w-7xl mx-auto w-full">
            <h2 class="text-4xl md:text-5xl font-bold text-center mb-12 text-gray-900">LOS OJOS DEL JAGUAR</h2>
            <p class="text-center text-gray-500 mb-8 -mt-8">Haz clic en un álbum para ver las fotos</p>
            <div id="gallery-grid">
                <!-- Los álbumes se cargarán dinámicamente aquí -->
            </div>
        </div>
    </section>

    <!-- Modal Lightbox para álbumes -->
    <div class="modal-overlay" id="album-modal">
        <button class="modal-close" onclick="closeAlbumModal()">&times;</button>
        <button class="modal-nav prev" onclick="prevPhoto()">&#8249;</button>
        <button class="modal-nav next" onclick="nextPhoto()">&#8250;</button>
        <div class="modal-album-title" id="modal-album-title"></div>
        <div class="modal-image-container">
            <img id="modal-image" src="" alt="">
        </div>
        <div class="modal-info" id="modal-info"></div>
    </div>

    <!-- Divider: Galería → Manifiesto -->
    <div class="section-divider bottom">
        <svg viewBox="0 0 1200 40" preserveAspectRatio="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M0,0 L0,20 Q400,24 800,18 T1200,22 L1200,0 Z" fill="#facc15"/>
            <path d="M0,20 Q400,24 800,18 T1200,22 L1200,40 L0,40 Z" fill="#2e1065"/>
        </svg>
    </div>

    <!-- SECCIÓN 4: MANIFIESTO - WORD BY WORD SCROLL -->
    <section id="manifiesto" class="relative text-white" style="background-color: #2e1065;">
        <div class="manifiesto-sticky" id="manifiesto-sticky">
            <div class="absolute inset-0 opacity-20" style="background-image: url('https://www.transparenttextures.com/patterns/asphalt-dark.png');"></div>
            <div class="absolute top-0 right-0 w-96 h-96 bg-pink-600 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-pulse"></div>
            <div class="absolute bottom-0 left-0 w-96 h-96 bg-cyan-600 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-pulse" style="animation-delay: 1s;"></div>

            <div class="manifiesto-content">
                <div class="max-w-5xl mx-auto px-6 relative z-10">
                    <div class="manifiesto-titulo" id="manifiesto-titulo"></div>
                    <div class="manifiesto-cuerpo" id="manifiesto-cuerpo"></div>
                </div>
            </div>
        </div>
    </section>

    <!-- Transición limpia: Manifiesto → Mapa (sin divider, mismo tono oscuro) -->

    <!-- SECCIÓN 5: MAPA DE TERRITORIALIZACIÓN -->
    <section id="mapa" style="background-color: #2e1065;">
        <div class="w-full">
            <div class="max-w-7xl mx-auto px-4 mb-4">
                <!-- Buscador del mapa -->
                <div class="relative max-w-xl mx-auto mb-4">
                    <input type="text" id="map-search" placeholder="Buscar organización..." class="w-full px-5 py-3 rounded-full bg-white/10 text-white border border-white/20 focus:border-orange-400 focus:outline-none placeholder-white/50 text-sm backdrop-blur" autocomplete="off">
                    <div id="map-search-results" class="absolute z-50 left-0 right-0 mt-1 bg-violet-950 rounded-xl shadow-2xl border border-white/15 hidden max-h-60 overflow-y-auto"></div>
                </div>
                <!-- Filtros por sector -->
                <div class="flex flex-wrap justify-center gap-2 mb-4" id="map-filters">
                    <button class="filter-btn" data-sector="Audiovisual">Audiovisual</button>
                    <button class="filter-btn" data-sector="Sonoro">Sonoro</button>
                    <button class="filter-btn" data-sector="Letras">Letras</button>
                    <button class="filter-btn" data-sector="Danza">Danza</button>
                    <button class="filter-btn" data-sector="Plástica">Plástica</button>
                    <button class="filter-btn" data-sector="Teatro">Teatro</button>
                    <button class="filter-btn" data-sector="Multidisciplinar">Multidisciplinar</button>
                    <button class="filter-btn" data-sector="Circo social">Circo</button>
                </div>
            </div>
            <div id="map"></div>
        </div>
    </section>

    <!-- Transición limpia: Mapa → Directorio (sin divider, mismo tono oscuro) -->

    <!-- SECCIÓN 6: DIRECTORIO DE ORGANIZACIONES -->
    <section id="directorio" style="background-color: #2e1065;" class="text-white">
        <div class="max-w-7xl mx-auto">
            <h2 class="text-4xl md:text-5xl font-bold text-center mb-8 text-white">Directorio Vivo de Organizaciones</h2>
            <!-- Buscador del directorio -->
            <div class="relative max-w-xl mx-auto mb-4">
                <input type="text" id="dir-search" placeholder="Buscar organización..." class="w-full px-5 py-3 rounded-full bg-white/10 text-white border border-white/20 focus:border-orange-400 focus:outline-none placeholder-white/50 text-sm backdrop-blur" autocomplete="off">
                <div id="dir-search-results" class="absolute z-50 left-0 right-0 mt-1 bg-zinc-800 rounded-xl shadow-2xl border border-zinc-600 hidden max-h-60 overflow-y-auto"></div>
            </div>
            <!-- Filtros por sector -->
            <div class="flex flex-wrap justify-center gap-2 mb-8" id="dir-filters">
                <button class="filter-btn-dir" data-sector="Audiovisual">Audiovisual</button>
                <button class="filter-btn-dir" data-sector="Sonoro">Sonoro</button>
                <button class="filter-btn-dir" data-sector="Letras">Letras</button>
                <button class="filter-btn-dir" data-sector="Danza">Danza</button>
                <button class="filter-btn-dir" data-sector="Plástica">Plástica</button>
                <button class="filter-btn-dir" data-sector="Teatro">Teatro</button>
                <button class="filter-btn-dir" data-sector="Multidisciplinar">Multidisciplinar</button>
                <button class="filter-btn-dir" data-sector="Circo social">Circo</button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4" id="directorio-grid">
                <!-- Las fichas se cargarán dinámicamente aquí -->
            </div>
        </div>
    </section>

    <!-- Divider: Directorio → Articulaciones -->
    <div class="section-divider bottom">
        <svg viewBox="0 0 1200 40" preserveAspectRatio="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M0,0 L0,21 Q250,17 500,23 T1000,19 T1200,22 L1200,0 Z" fill="#2e1065"/>
            <path d="M0,21 Q250,17 500,23 T1000,19 T1200,22 L1200,40 L0,40 Z" fill="#f59e0b"/>
        </svg>
    </div>

    <!-- SECCIÓN 7: ARTICULACIONES -->
    <section id="articulaciones" class="bg-gradient-to-r from-amber-400 to-orange-500 text-white">
        <div class="max-w-6xl mx-auto">
            <h2 class="text-4xl md:text-5xl font-bold text-center mb-12">EL ENREDO</h2>
            <div class="grid md:grid-cols-2 gap-6">
                <div class="bg-white/10 backdrop-blur rounded-xl p-6">
                    <h3 class="text-2xl font-bold mb-4">Redam × Yucuta</h3>
                    <p>Colaboración en proyectos de preservación cultural amazónica</p>
                </div>
                <div class="bg-white/10 backdrop-blur rounded-xl p-6">
                    <h3 class="text-2xl font-bold mb-4">Kombilesa Mi × ODEC</h3>
                    <p>Alianza para el fortalecimiento de identidades juveniles</p>
                </div>
                <div class="bg-white/10 backdrop-blur rounded-xl p-6">
                    <h3 class="text-2xl font-bold mb-4">Bari Rock × La Tigra</h3>
                    <p>Fusión musical y cultural en territorios de frontera</p>
                </div>
                <div class="bg-white/10 backdrop-blur rounded-xl p-6">
                    <h3 class="text-2xl font-bold mb-4">Biohoty × Enraizarte</h3>
                    <p>Intercambio de saberes ambientales y artísticos</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Divider: Articulaciones → Salvaguarda -->
    <div class="section-divider bottom">
        <svg viewBox="0 0 1200 40" preserveAspectRatio="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M0,0 L0,19 Q350,24 700,18 T1200,21 L1200,0 Z" fill="#f59e0b"/>
            <path d="M0,19 Q350,24 700,18 T1200,21 L1200,40 L0,40 Z" fill="#15803d"/>
        </svg>
    </div>

    <!-- SECCIÓN 8: SALVAGUARDA -->
    <section id="salvaguarda" class="bg-gradient-to-br from-green-700 to-teal-800 text-white">
        <div class="max-w-4xl mx-auto">
            <h2 class="text-4xl md:text-5xl font-bold text-center mb-12">Cuando el Territorio Habla</h2>
            <div class="bg-white/10 backdrop-blur rounded-2xl p-8 md:p-12">
                <p class="text-lg leading-relaxed mb-6">
                    La salvaguarda no es solo un protocolo administrativo, es el compromiso de escuchar 
                    las voces ancestrales que habitan los territorios donde trabajamos.
                </p>
                <p class="text-lg leading-relaxed mb-6">
                    Reconocemos que cada organización es guardiana de saberes, tradiciones y cosmovisiones 
                    que merecen ser preservadas, transmitidas y celebradas.
                </p>
                <div class="border-l-4 border-white pl-6 italic">
                    <p class="text-xl">"El territorio no es un lugar, es una memoria viva que late en cada uno de nosotros"</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Divider: Salvaguarda → Envolvente -->
    <div class="section-divider bottom">
        <svg viewBox="0 0 1200 40" preserveAspectRatio="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M0,0 L0,22 Q300,17 600,23 T1200,19 L1200,0 Z" fill="#15803d"/>
            <path d="M0,22 Q300,17 600,23 T1200,19 L1200,40 L0,40 Z" fill="#4f46e5"/>
        </svg>
    </div>

    <!-- SECCIÓN 9: ENVOLVENTE -->
    <section id="envolvente" class="bg-gradient-to-r from-indigo-600 to-purple-700 text-white">
        <div class="max-w-4xl mx-auto">
            <h2 class="text-4xl md:text-5xl font-bold text-center mb-12">TRASCENDENTE</h2>
            <div class="bg-white/10 backdrop-blur rounded-2xl p-8 md:p-12">
                <h3 class="text-2xl font-bold mb-6">Proceso de Integración a la Red</h3>
                <div class="space-y-6">
                    <div class="flex items-start gap-4">
                        <div class="bg-white text-indigo-600 rounded-full w-10 h-10 flex items-center justify-center font-bold flex-shrink-0">1</div>
                        <div>
                            <h4 class="font-bold text-lg mb-2">Manifestación de Interés</h4>
                            <p>Las organizaciones expresan su deseo de formar parte de la red</p>
                        </div>
                    </div>
                    <div class="flex items-start gap-4">
                        <div class="bg-white text-indigo-600 rounded-full w-10 h-10 flex items-center justify-center font-bold flex-shrink-0">2</div>
                        <div>
                            <h4 class="font-bold text-lg mb-2">Caracterización</h4>
                            <p>Proceso de conocimiento mutuo y reconocimiento territorial</p>
                        </div>
                    </div>
                    <div class="flex items-start gap-4">
                        <div class="bg-white text-indigo-600 rounded-full w-10 h-10 flex items-center justify-center font-bold flex-shrink-0">3</div>
                        <div>
                            <h4 class="font-bold text-lg mb-2">Formalización</h4>
                            <p>Acuerdos de colaboración y participación activa en la red</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Divider: Envolvente → Footer -->
    <div class="section-divider bottom">
        <svg viewBox="0 0 1200 40" preserveAspectRatio="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M0,0 L0,20 Q400,25 800,18 T1200,22 L1200,0 Z" fill="#4f46e5"/>
            <path d="M0,20 Q400,25 800,18 T1200,22 L1200,40 L0,40 Z" fill="#111827"/>
        </svg>
    </div>

    <!-- FOOTER -->
    <footer id="contacto" class="bg-gray-900 text-white pt-12 pb-6">
        <div class="max-w-7xl mx-auto px-4">
            <!-- Marquesina de logos de organizaciones -->
            <p class="text-center text-white/40 text-xs uppercase tracking-widest mb-4">Organizaciones participantes</p>
            <div class="logos-marquee mb-10" id="logos-marquee">
                <div class="marquee-track" id="marquee-track">
                    <!-- Se llena dinámicamente con JS -->
                </div>
            </div>

            <!-- Contacto -->
            <div class="grid md:grid-cols-2 gap-8 max-w-4xl mx-auto mb-10">
                <div class="bg-white/5 backdrop-blur rounded-xl p-6 text-center">
                    <h3 class="text-lg font-bold mb-3">Email</h3>
                    <a href="mailto:redinterculturaljuvenilcol@gmail.com" class="text-orange-400 hover:text-orange-300 text-sm">
                        redinterculturaljuvenilcol@gmail.com
                    </a>
                </div>
                <div class="bg-white/5 backdrop-blur rounded-xl p-6 text-center">
                    <h3 class="text-lg font-bold mb-3">Instagram</h3>
                    <div class="flex justify-center gap-5">
                        <a href="https://www.instagram.com/rijcol" target="_blank" rel="noopener" class="social-icon"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zM12 0C8.741 0 8.333.014 7.053.072 2.695.272.273 2.69.073 7.052.014 8.333 0 8.741 0 12c0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98C8.333 23.986 8.741 24 12 24c3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98C15.668.014 15.259 0 12 0zm0 5.838a6.162 6.162 0 100 12.324 6.162 6.162 0 000-12.324zM12 16a4 4 0 110-8 4 4 0 010 8zm6.406-11.845a1.44 1.44 0 100 2.881 1.44 1.44 0 000-2.881z"/></svg></a>
                        <span class="text-white/60 text-sm self-center">@rijcol</span>
                    </div>
                </div>
            </div>

            <!-- Créditos -->
            <div class="border-t border-white/10 pt-6 text-center">
                <div class="flex flex-col md:flex-row justify-center items-center gap-3 mb-4 text-sm text-white/60">
                    <p><strong class="text-white/80">Orientación Estratégica:</strong> Jamie Ruiz</p>
                    <span class="hidden md:inline text-white/20">|</span>
                    <p><strong class="text-white/80">Realización Gráfica y Audiovisual:</strong> Felipe Camacho Otero</p>
                </div>
                <img src="assets/logos/RIJ_SIGLA.png?v=20260218" alt="RIJ" class="h-10 w-auto mx-auto mb-3 opacity-50">
                <p class="text-white/30 text-xs">
                    © 2026 Red Intercultural Juvenil · Todos los derechos reservados
                </p>
            </div>
        </div>
    </footer>

    <script>
        // Array de fotos de organizaciones (123 fotos totales)
        const fotosOrgs = [
            'assets/photos_orgs/01_CODIGO_ESTILO_CREW_2025.jpg',
            'assets/photos_orgs/01_CUMBRE_CASA_CULTURAL.jpg',
            'assets/photos_orgs/01_MALOKA_JOVEN_2025.jpg',
            'assets/photos_orgs/01_RED_CEPELA_2025.jpg',
            'assets/photos_orgs/01_THE_GIANT_CORPORATION_2025.jpg',
            'assets/photos_orgs/02_CODIGO_ESTILO_CREW_2025.jpg',
            'assets/photos_orgs/02_CUMBRE_CASA_CULTURAL.jpg',
            'assets/photos_orgs/02_MALOKA_JOVEN_2025.jpg',
            'assets/photos_orgs/02_RED_CEPELA_2025.jpg',
            'assets/photos_orgs/02_THE_GIANT_CORPORATION_2025.jpg',
            'assets/photos_orgs/03_CODIGO_ESTILO_CREW_2025.jpg',
            'assets/photos_orgs/03_CUMBRE_CASA_CULTURAL.jpg',
            'assets/photos_orgs/03_MALOKA_JOVEN_2025.jpg',
            'assets/photos_orgs/03_RED_CEPELA_2025.jpg',
            'assets/photos_orgs/03_THE_GIANT_CORPORATION_2025.jpg',
            'assets/photos_orgs/04_CODIGO_ESTILO_CREW_2025.jpg',
            'assets/photos_orgs/04_CUMBRE_CASA_CULTURAL.jpg',
            'assets/photos_orgs/04_MALOKA_JOVEN_2025.jpg',
            'assets/photos_orgs/04_RED_CEPELA_2025.jpg',
            'assets/photos_orgs/04_THE_GIANT_CORPORATION_2025.jpg',
            'assets/photos_orgs/05_CODIGO_ESTILO_CREW_2025.jpg',
            'assets/photos_orgs/05_CUMBRE_CASA_CULTURAL.jpg',
            'assets/photos_orgs/05_MALOKA_JOVEN_2025.jpg',
            'assets/photos_orgs/05_RED_CEPELA_2025.jpg',
            'assets/photos_orgs/05_THE_GIANT_CORPORATION_2025.jpg',
            'assets/photos_orgs/06_CODIGO_ESTILO_CREW_2025.jpg',
            'assets/photos_orgs/06_CUMBRE_CASA_CULTURAL.jpg',
            'assets/photos_orgs/06_MALOKA_JOVEN_2025.jpg',
            'assets/photos_orgs/06_RED_CEPELA_2025.jpg',
            'assets/photos_orgs/06_THE_GIANT_CORPORATION_2025.jpg',
            'assets/photos_orgs/07_CODIGO_ESTILO_CREW_2025.jpg',
            'assets/photos_orgs/07_CUMBRE_CASA_CULTURAL.jpg',
            'assets/photos_orgs/07_MALOKA_JOVEN_2025.jpg',
            'assets/photos_orgs/07_RED_CEPELA_2025.jpg',
            'assets/photos_orgs/07_THE_GIANT_CORPORATION_2025.jpg',
            'assets/photos_orgs/08_CODIGO_ESTILO_CREW_2025.jpg',
            'assets/photos_orgs/08_CUMBRE_CASA_CULTURAL.jpg',
            'assets/photos_orgs/08_MALOKA_JOVEN_2025.jpg',
            'assets/photos_orgs/08_RED_CEPELA_2025.jpg',
            'assets/photos_orgs/08_THE_GIANT_CORPORATION_2025.jpg',
            'assets/photos_orgs/09_CODIGO_ESTILO_CREW_2025.jpg',
            'assets/photos_orgs/09_CUMBRE_CASA_CULTURAL.jpg',
            'assets/photos_orgs/09_MALOKA_JOVEN_2025.jpg',
            'assets/photos_orgs/09_RED_CEPELA_2025.jpg',
            'assets/photos_orgs/09_THE_GIANT_CORPORATION_2025.jpg',
            'assets/photos_orgs/10_CODIGO_ESTILO_CREW_2025.jpg',
            'assets/photos_orgs/10_CUMBRE_CASA_CULTURAL.jpg',
            'assets/photos_orgs/10_MALOKA_JOVEN_2025.jpg',
            'assets/photos_orgs/10_RED_CEPELA_2025.jpg',
            'assets/photos_orgs/10_THE_GIANT_CORPORATION_2025.jpg',
            'assets/photos_orgs/11_CODIGO_ESTILO_CREW_2025.jpg',
            'assets/photos_orgs/11_CUMBRE_CASA_CULTURAL.jpg',
            'assets/photos_orgs/11_MALOKA_JOVEN_2025.jpg',
            'assets/photos_orgs/11_RED_CEPELA_2025.jpg',
            'assets/photos_orgs/11_THE_GIANT_CORPORATION_2025.jpg',
            'assets/photos_orgs/12_CODIGO_ESTILO_CREW_2025.jpg',
            'assets/photos_orgs/12_CUMBRE_CASA_CULTURAL.jpg',
            'assets/photos_orgs/12_MALOKA_JOVEN_2025.jpg',
            'assets/photos_orgs/12_RED_CEPELA_2025.jpg',
            'assets/photos_orgs/12_THE_GIANT_CORPORATION_2025.jpg',
            'assets/photos_orgs/13_CODIGO_ESTILO_CREW_2025.jpg',
            'assets/photos_orgs/13_CUMBRE_CASA_CULTURAL.jpg',
            'assets/photos_orgs/13_MALOKA_JOVEN_2025.jpg',
            'assets/photos_orgs/13_RED_CEPELA_2025.jpg',
            'assets/photos_orgs/13_THE_GIANT_CORPORATION_2025.jpg',
            'assets/photos_orgs/14_CUMBRE_CASA_CULTURAL.jpg',
            'assets/photos_orgs/14_MALOKA_JOVEN_2025.jpg',
            'assets/photos_orgs/14_RED_CEPELA_2025.jpg',
            'assets/photos_orgs/14_THE_GIANT_CORPORATION_2025.jpg',
            'assets/photos_orgs/15_GUAQUE_SOPO_2025.jpg',
            'assets/photos_orgs/15_MALOKA_JOVEN_2025.jpg',
            'assets/photos_orgs/15_RED_CEPELA_2025.jpg',
            'assets/photos_orgs/15_THE_GIANT_CORPORATION_2025.jpg',
            'assets/photos_orgs/16_GUAQUE_SOPO_2025.jpg',
            'assets/photos_orgs/16_RED_CEPELA_2025.jpg',
            'assets/photos_orgs/17_GUAQUE_SOPO_2025.jpg',
            'assets/photos_orgs/17_RED_CEPELA_2025.jpg',
            'assets/photos_orgs/18_GUAQUE_SOPO_2025.jpg',
            'assets/photos_orgs/18_RED_CEPELA_2025.jpg',
            'assets/photos_orgs/19_GUAQUE_SOPO_2025.jpg',
            'assets/photos_orgs/19_RED_CEPELA_2025.jpg',
            'assets/photos_orgs/20_GUAQUE_SOPO_2025.jpg',
            'assets/photos_orgs/20_RED_CEPELA_2025.jpg',
            'assets/photos_orgs/21_GUAQUE_SOPO_2025.jpg',
            'assets/photos_orgs/22_GUAQUE_SOPO_2025.jpg',
            'assets/photos_orgs/23_GUAQUE_SOPO_2025.jpg',
            'assets/photos_orgs/24_GUAQUE_SOPO_2025.jpg',
            'assets/photos_orgs/25_GUAQUE_SOPO_2025.jpg',
            'assets/photos_orgs/26_GUAQUE_SOPO_2025.jpg',
            'assets/photos_orgs/27_GUAQUE_SOPO_2025.jpg',
            'assets/photos_orgs/28_GUAQUE_SOPO_2025.jpg',
            'assets/photos_orgs/29_GUAQUE_SOPO_2025.jpg',
            'assets/photos_orgs/01_ELEMENTS_2025.jpg',
            'assets/photos_orgs/02_ELEMENTS_2025.jpg',
            'assets/photos_orgs/03_ELEMENTS_2025.jpg',
            'assets/photos_orgs/04_ELEMENTS_2025.jpg',
            'assets/photos_orgs/05_ELEMENTS_2025.jpg',
            'assets/photos_orgs/06_ELEMENTS_2025.jpg',
            'assets/photos_orgs/07_ELEMENTS_2025.jpg',
            'assets/photos_orgs/08_ELEMENTS_2025.jpg',
            'assets/photos_orgs/09_ELEMENTS_2025.jpg',
            'assets/photos_orgs/10_ELEMENTS_2025.jpg',
            'assets/photos_orgs/11_ELEMENTS_2025.jpg',
            'assets/photos_orgs/12_ELEMENTS_2025.jpg',
            'assets/photos_orgs/13_ELEMENTS_2025.jpg',
            'assets/photos_orgs/14_ELEMENTS_2025.jpg',
            'assets/photos_orgs/15_ELEMENTS_2025.jpg',
            'assets/photos_orgs/01_INFLUENCERS_ETNICOS_2025.jpg',
            'assets/photos_orgs/02_INFLUENCERS_ETNICOS_2025.jpg',
            'assets/photos_orgs/03_INFLUENCERS_ETNICOS_2025.jpg',
            'assets/photos_orgs/04_INFLUENCERS_ETNICOS_2025.jpg',
            'assets/photos_orgs/05_INFLUENCERS_ETNICOS_2025.jpg',
            'assets/photos_orgs/06_INFLUENCERS_ETNICOS_2025.jpg',
            'assets/photos_orgs/07_INFLUENCERS_ETNICOS_2025.jpg',
            'assets/photos_orgs/08_INFLUENCERS_ETNICOS_2025.jpg',
            'assets/photos_orgs/09_INFLUENCERS_ETNICOS_2025.jpg',
            'assets/photos_orgs/10_INFLUENCERS_ETNICOS_2025.jpg',
            'assets/photos_orgs/11_INFLUENCERS_ETNICOS_2025.jpg',
            'assets/photos_orgs/12_INFLUENCERS_ETNICOS_2025.jpg',
            'assets/photos_orgs/13_INFLUENCERS_ETNICOS_2025.jpg',
            'assets/photos_orgs/14_INFLUENCERS_ETNICOS_2025.jpg',
            'assets/photos_orgs/15_INFLUENCERS_ETNICOS_2025.jpg',
            'assets/photos_orgs/16_INFLUENCERS_ETNICOS_2025.jpg'
        ];

        // Sistema de shuffle sin repeticiones
        let shuffledPhotos = [];
        let currentShuffleIndex = 0;

        // Crear nuevo shuffle
        function createShuffle() {
            shuffledPhotos = [...fotosOrgs];
            // Algoritmo Fisher-Yates para mezclar
            for (let i = shuffledPhotos.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffledPhotos[i], shuffledPhotos[j]] = [shuffledPhotos[j], shuffledPhotos[i]];
            }
            currentShuffleIndex = 0;
        }

        // Obtener siguiente foto del shuffle
        function getNextPhoto() {
            if (currentShuffleIndex >= shuffledPhotos.length) {
                createShuffle();
            }
            const photo = shuffledPhotos[currentShuffleIndex];
            currentShuffleIndex++;
            return photo;
        }

        // Mapeo de nombres de fotos a organizaciones
        function getOrgFromPhoto(photoPath) {
            const filename = photoPath.split('/').pop().toUpperCase();
            
            if (filename.includes('CODIGO_ESTILO_CREW')) {
                return organizaciones.find(org => 
                    org.nombre && org.nombre.toLowerCase().includes('código estilo')
                );
            } else if (filename.includes('THE_GIANT_CORPORATION')) {
                return organizaciones.find(org => 
                    org.nombre && org.nombre.toLowerCase().includes('giant')
                );
            } else if (filename.includes('RED_CEPELA')) {
                return organizaciones.find(org => 
                    org.nombre && org.nombre.toLowerCase().includes('cepela')
                );
            } else if (filename.includes('CASA_CULTURAL')) {
                return organizaciones.find(org => 
                    org.nombre && org.nombre.toLowerCase().includes('casa cultural')
                );
            } else if (filename.includes('MALOKA')) {
                return organizaciones.find(org => 
                    org.nombre && org.nombre.toLowerCase().includes('maloka')
                );
            } else if (filename.includes('GUAQUE') || filename.includes('SOPO')) {
                return organizaciones.find(org => 
                    org.nombre && (org.nombre.toLowerCase().includes('guaque') || org.municipio.toLowerCase().includes('sopó'))
                );
            } else if (filename.includes('ELEMENTS')) {
                return organizaciones.find(org => 
                    org.nombre && org.nombre.toLowerCase().includes('elements')
                );
            } else if (filename.includes('INFLUENCERS_ETNICOS')) {
                return organizaciones.find(org => 
                    org.nombre && org.nombre.toLowerCase().includes('influencers')
                );
            }
            
            return null;
        }

        // Precarga de todas las imágenes con promesas
        let imagesPreloaded = false;
        const preloadedImages = [];
        
        function preloadImages() {
            return new Promise((resolve) => {
                let loaded = 0;
                const total = fotosOrgs.length;
                fotosOrgs.forEach((src) => {
                    const img = new Image();
                    img.onload = () => {
                        loaded++;
                        if (loaded >= total) {
                            imagesPreloaded = true;
                            resolve();
                        }
                    };
                    img.onerror = () => {
                        loaded++;
                        if (loaded >= total) {
                            imagesPreloaded = true;
                            resolve();
                        }
                    };
                    img.src = src;
                    preloadedImages.push(img);
                });
            });
        }

        // Función para seleccionar foto con sistema de shuffle
        let currentPhotoPath = null;
        let activeLayer = 1; // 1 o 2 - cuál capa está visible ahora
        
        function setRandomBackground(fade) {
            const layer1 = document.getElementById('bg-layer-1');
            const layer2 = document.getElementById('bg-layer-2');
            if (!layer1 || !layer2) return;
            
            const randomPhoto = getNextPhoto();
            currentPhotoPath = randomPhoto;
            
            if (!fade) {
                // Primera carga: mostrar directamente en layer1
                layer1.style.backgroundImage = "url('" + randomPhoto + "')";
                layer1.style.opacity = '1';
                layer1.style.zIndex = '0';
                layer2.style.opacity = '0';
                layer2.style.zIndex = '1';
                activeLayer = 1;
                return;
            }
            
            // Crossfade: la nueva foto se carga en la capa inactiva (encima, invisible)
            // y luego hace fade in, tapando la anterior
            if (activeLayer === 1) {
                // layer1 está visible, cargar nueva foto en layer2 (encima)
                layer2.style.transition = 'none'; // quitar transición para poner invisible
                layer2.style.opacity = '0';
                layer2.style.zIndex = '1'; // encima
                layer1.style.zIndex = '0'; // debajo
                layer2.style.backgroundImage = "url('" + randomPhoto + "')";
                
                // Forzar reflow para que el cambio de opacity sin transición tome efecto
                layer2.offsetHeight;
                
                // Ahora sí restaurar transición y hacer fade in
                layer2.style.transition = 'opacity 3s ease-in-out';
                
                // Pequeño delay y luego fade in
                requestAnimationFrame(() => {
                    requestAnimationFrame(() => {
                        layer2.style.opacity = '1';
                    });
                });
                
                activeLayer = 2;
            } else {
                // layer2 está visible, cargar nueva foto en layer1 (encima)
                layer1.style.transition = 'none'; // quitar transición para poner invisible
                layer1.style.opacity = '0';
                layer1.style.zIndex = '1'; // encima
                layer2.style.zIndex = '0'; // debajo
                layer1.style.backgroundImage = "url('" + randomPhoto + "')";
                
                // Forzar reflow
                layer1.offsetHeight;
                
                // Restaurar transición y hacer fade in
                layer1.style.transition = 'opacity 3s ease-in-out';
                
                requestAnimationFrame(() => {
                    requestAnimationFrame(() => {
                        layer1.style.opacity = '1';
                    });
                });
                
                activeLayer = 1;
            }
        }

        // Cambiar foto cada 5 segundos
        function startPhotoRotation() {
            setInterval(() => {
                setRandomBackground(true);
            }, 5000);
        }

        // ========== SVG SOCIAL ICONS ==========
        const socialSVGs = {
            instagram: '<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zM12 0C8.741 0 8.333.014 7.053.072 2.695.272.273 2.69.073 7.052.014 8.333 0 8.741 0 12c0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98C8.333 23.986 8.741 24 12 24c3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98C15.668.014 15.259 0 12 0zm0 5.838a6.162 6.162 0 100 12.324 6.162 6.162 0 000-12.324zM12 16a4 4 0 110-8 4 4 0 010 8zm6.406-11.845a1.44 1.44 0 100 2.881 1.44 1.44 0 000-2.881z"/></svg>',
            facebook: '<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>',
            tiktok: '<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12.525.02c1.31-.02 2.61-.01 3.91-.02.08 1.53.63 3.09 1.75 4.17 1.12 1.11 2.7 1.62 4.24 1.79v4.03c-1.44-.05-2.89-.35-4.2-.97-.57-.26-1.1-.59-1.62-.93-.01 2.92.01 5.84-.02 8.75-.08 1.4-.54 2.79-1.35 3.94-1.31 1.92-3.58 3.17-5.91 3.21-1.43.08-2.86-.31-4.08-1.03-2.02-1.19-3.44-3.37-3.65-5.71-.02-.5-.03-1-.01-1.49.18-1.9 1.12-3.72 2.58-4.96 1.66-1.44 3.98-2.13 6.15-1.72.02 1.48-.04 2.96-.04 4.44-.99-.32-2.15-.23-3.02.37-.63.41-1.11 1.04-1.36 1.75-.21.51-.15 1.07-.14 1.61.24 1.64 1.82 3.02 3.5 2.87 1.12-.01 2.19-.66 2.77-1.61.19-.33.4-.67.41-1.06.1-1.79.06-3.57.07-5.36.01-4.03-.01-8.05.02-12.07z"/></svg>',
            youtube: '<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M23.498 6.186a3.016 3.016 0 00-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 00.502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 002.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 002.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg>',
            twitter: '<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>',
            web: '<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>'
        };

        function socialLink(type, url) {
            if (!url || !socialSVGs[type]) return '';
            return '<a href="' + url + '" target="_blank" class="social-icon" rel="noopener" onclick="event.stopPropagation()">' + socialSVGs[type] + '</a>';
        }

        function buildSocialLinks(org) {
            let html = '';
            if (org.web) html += socialLink('web', org.web.startsWith('http') ? org.web : 'https://' + org.web);
            if (org.instagram) html += socialLink('instagram', org.instagram);
            if (org.facebook) html += socialLink('facebook', org.facebook);
            if (org.youtube) html += socialLink('youtube', org.youtube);
            if (org.tiktok) html += socialLink('tiktok', org.tiktok);
            if (org.twitter) html += socialLink('twitter', org.twitter);
            return html;
        }

        // ========== MAPA ==========
        let mapMarkers = [];
        let mapClusterGroup = null;
        let currentMapFilter = 'all';
        let currentMapSearch = '';

        function initMap() {
            const defaultCenter = [4.0, -72.0];
            const defaultZoom = 5;
            const map = L.map('map', {
                dragging: false,
                touchZoom: false,
                scrollWheelZoom: false,
                doubleClickZoom: false,
                boxZoom: false,
                keyboard: false,
                zoomControl: false,
                zoomSnap: 0.5,
                zoomDelta: 0.5
            }).setView(defaultCenter, defaultZoom);
            window.mapInstance = map;
            window.mapDefaultCenter = defaultCenter;
            window.mapDefaultZoom = defaultZoom;
            
            // CartoDB Voyager como base, con filtro CSS para tonos vibrantes
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://carto.com/">CARTO</a> &copy; <a href="https://openstreetmap.org">OpenStreetMap</a>',
                maxZoom: 20,
                subdomains: 'abcd'
            }).addTo(map);

            // Cluster group con icono RIJ
            mapClusterGroup = L.markerClusterGroup({
                maxClusterRadius: 55,
                iconCreateFunction: function(cluster) {
                    const count = cluster.getChildCount();
                    return L.divIcon({
                        html: '<div class="cluster-rij"><img src="assets/logos/RIJ_SIGLA.png" alt="RIJ"><span class="cluster-count">' + count + '</span></div>',
                        className: 'marker-cluster-custom',
                        iconSize: [52, 52],
                        iconAnchor: [26, 26]
                    });
                },
                spiderfyOnMaxZoom: true,
                showCoverageOnHover: false,
                zoomToBoundsOnClick: true,
                animate: true
            });

            // Crear marcadores individuales con logo de organización
            organizaciones.forEach(org => {
                if (!org.lat || !org.lng) return;
                
                const hasLogo = org.logo && org.logo.length > 0;
                const icon = L.divIcon({
                    html: '<div class="org-marker">' + (hasLogo ? '<img src="' + org.logo + '" alt="' + org.nombre + '" onerror="this.src=\'assets/logos/RIJ_SIGLA.png\'">' : '<img src="assets/logos/RIJ_SIGLA.png" alt="RIJ">') + '</div>',
                    className: '',
                    iconSize: [48, 48],
                    iconAnchor: [24, 24],
                    popupAnchor: [0, -26]
                });
                
                const marker = L.marker([org.lat, org.lng], { icon: icon });
                marker.orgData = org;
                
                const socials = buildSocialLinks(org);
                marker.bindPopup(
                    '<div class="org-popup">' +
                    '<div class="popup-header">' +
                    (hasLogo ? '<img src="' + org.logo + '" alt="' + org.nombre + '" onerror="this.style.display=\'none\'">' : '') +
                    '<div class="popup-title"><h3>' + org.nombre + '</h3><p>' + org.municipio + '</p></div>' +
                    '</div>' +
                    '<div class="popup-details">' +
                    '<p style="color:#888;font-size:0.68rem;">' + org.sectores.join(' · ') + '</p>' +
                    '<p><strong>' + org.representante + '</strong></p>' +
                    '<p><a href="mailto:' + org.email + '" style="color:#fb923c;text-decoration:underline;">' + org.email + '</a></p>' +
                    '<p><a href="tel:' + org.telefono + '" style="color:#fb923c;text-decoration:underline;">' + org.telefono + '</a></p>' +
                    '</div>' +
                    (socials ? '<div class="popup-socials">' + socials + '</div>' : '') +
                    '</div>',
                    { autoPanPadding: [20, 20], maxWidth: 250 }
                );
                
                mapMarkers.push(marker);
            });

            updateMapMarkers();
            map.addLayer(mapClusterGroup);

            // Al cerrar un popup, volver a vista por defecto
            map.on('popupclose', function() {
                setTimeout(function() {
                    map.flyTo(defaultCenter, defaultZoom, { duration: 0.8 });
                }, 300);
            });

            // Click en área vacía del mapa -> volver a vista por defecto
            map.on('click', function(e) {
                if (map.getZoom() !== defaultZoom) {
                    map.flyTo(defaultCenter, defaultZoom, { duration: 0.8 });
                }
            });

            // Search
            const searchInput = document.getElementById('map-search');
            const searchResults = document.getElementById('map-search-results');
            
            searchInput.addEventListener('input', function() {
                const q = this.value.trim().toLowerCase();
                currentMapSearch = q;
                if (q.length < 1) {
                    searchResults.classList.add('hidden');
                    searchResults.innerHTML = '';
                    updateMapMarkers();
                    return;
                }
                const matches = organizaciones.filter(o => 
                    o.nombre.toLowerCase().includes(q) || 
                    (o.nombreCompleto && o.nombreCompleto.toLowerCase().includes(q)) ||
                    o.municipio.toLowerCase().includes(q) ||
                    o.departamento.toLowerCase().includes(q)
                );
                if (matches.length > 0) {
                    searchResults.innerHTML = matches.map(o => 
                        '<div class="search-result-item" data-org-id="' + o.id + '"><span class="sr-name">' + o.nombre + '</span><br><span class="sr-loc">' + o.municipio + '</span></div>'
                    ).join('');
                    searchResults.classList.remove('hidden');
                    searchResults.querySelectorAll('.search-result-item').forEach(el => {
                        el.addEventListener('click', function() {
                            const orgId = parseInt(this.dataset.orgId);
                            const org = organizaciones.find(o => o.id === orgId);
                            if (org && org.lat && org.lng) {
                                map.flyTo([org.lat, org.lng], 13, { duration: 0.8 });
                                const m = mapMarkers.find(mk => mk.orgData && mk.orgData.id === orgId);
                                if (m) setTimeout(() => m.openPopup(), 900);
                            }
                            searchInput.value = org ? org.nombre : '';
                            searchResults.classList.add('hidden');
                        });
                    });
                } else {
                    searchResults.innerHTML = '<div class="search-result-item" style="opacity:0.4">Sin resultados</div>';
                    searchResults.classList.remove('hidden');
                }
            });

            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                    searchResults.classList.add('hidden');
                }
            });

            // Filters - toggle behavior
            document.querySelectorAll('#map-filters .filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (this.classList.contains('active')) {
                        // Deselect - show all
                        this.classList.remove('active');
                        currentMapFilter = 'all';
                    } else {
                        document.querySelectorAll('#map-filters .filter-btn').forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                        currentMapFilter = this.dataset.sector;
                    }
                    updateMapMarkers();
                    // Zoom a los marcadores filtrados o volver a vista por defecto
                    setTimeout(function() {
                        if (currentMapFilter === 'all') {
                            map.flyTo(window.mapDefaultCenter, window.mapDefaultZoom, { duration: 0.8 });
                        } else if (mapClusterGroup.getLayers().length > 0) {
                            var bounds = mapClusterGroup.getBounds();
                            if (bounds.isValid()) {
                                map.flyToBounds(bounds.pad(0.3), { duration: 0.8 });
                            }
                        }
                    }, 100);
                });
            });
        }

        function updateMapMarkers() {
            if (!mapClusterGroup) return;
            mapClusterGroup.clearLayers();
            mapMarkers.forEach(m => {
                const org = m.orgData;
                if (!org) return;
                const matchesSector = currentMapFilter === 'all' || org.sectores.includes(currentMapFilter) || (currentMapFilter === 'Plástica' && org.sectores.includes('Cerámica'));
                const matchesSearch = !currentMapSearch || 
                    org.nombre.toLowerCase().includes(currentMapSearch) ||
                    (org.nombreCompleto && org.nombreCompleto.toLowerCase().includes(currentMapSearch)) ||
                    org.municipio.toLowerCase().includes(currentMapSearch);
                if (matchesSector && matchesSearch) {
                    mapClusterGroup.addLayer(m);
                }
            });
        }

        // Agrupar fotos por organización
        function getAlbums() {
            const albums = {};
            const albumNames = {
                'CODIGO_ESTILO_CREW_2025': 'Código Estilo Crew 2025',
                'CUMBRE_CASA_CULTURAL': 'Cumbre Casa Cultural',
                'MALOKA_JOVEN_2025': 'Maloka Joven 2025',
                'GUAQUE_SOPO_2025': 'Guaque Sopó 2025',
                'RED_CEPELA_2025': 'Red Cepela 2025',
                'THE_GIANT_CORPORATION_2025': 'The Giant Corporation 2025',
                'ELEMENTS_2025': 'Elements 2025',
                'INFLUENCERS_ETNICOS_2025': 'Influencers Étnicos 2025'
            };
            
            fotosOrgs.forEach(foto => {
                const filename = foto.split('/').pop();
                // Extraer nombre de org quitando el número inicial
                const match = filename.match(/^\d+_(.+)\.jpg$/i);
                if (match) {
                    const key = match[1];
                    if (!albums[key]) {
                        albums[key] = {
                            name: albumNames[key] || key.replace(/_/g, ' '),
                            photos: []
                        };
                    }
                    albums[key].photos.push(foto);
                }
            });
            return albums;
        }

        // Variables del modal
        let currentAlbumPhotos = [];
        let currentPhotoIndex = 0;
        let modalAutoplay = null;

        // Cargar galería como álbumes - grid responsivo según cantidad
        let lastGalleryMode = null;
        function loadGallery() {
            const grid = document.getElementById('gallery-grid');
            const albums = getAlbums();
            const albumKeys = Object.keys(albums);
            const isMobile = window.innerWidth < 768;
            
            // Evitar reconstruir si el modo no cambió
            const mode = isMobile ? 'mobile' : 'desktop';
            if (mode === lastGalleryMode) return;
            lastGalleryMode = mode;
            
            // Construir filas según tamaño de pantalla
            const rows = [];
            let i = 0;
            
            if (isMobile) {
                // Móvil: todas las filas de 2, con offset alterno para honeycomb
                while (i < albumKeys.length) {
                    rows.push(albumKeys.slice(i, i + 2));
                    i += 2;
                }
            } else {
                // Desktop: filas impares = 3, pares = 2
                const cols = 3;
                let isOddRow = true;
                while (i < albumKeys.length) {
                    const rowSize = isOddRow ? cols : Math.max(cols - 1, 1);
                    rows.push(albumKeys.slice(i, i + rowSize));
                    i += rowSize;
                    isOddRow = !isOddRow;
                }
            }
            
            grid.className = 'honeycomb';
            
            let idx = 0;
            grid.innerHTML = rows.map((row, rowIndex) => {
                const items = row.map(key => {
                    const album = albums[key];
                    const coverPhoto = album.photos[0];
                    const html = `
                        <div class="hex-wrap">
                            <div class="album-card" onclick="openAlbum('${key}')" id="album-${idx}">
                                <div class="album-bg" style="background-image: url('${coverPhoto}'); opacity: 1;" data-album-key="${key}"></div>
                                <div class="album-overlay"></div>
                                <div class="album-info">
                                    <h3>${album.name}</h3>
                                    <p>📷 ${album.photos.length} fotos</p>
                                </div>
                            </div>
                        </div>
                    `;
                    idx++;
                    return html;
                }).join('');
                const offsetClass = (isMobile && rowIndex % 2 === 1) ? ' hex-row-offset' : '';
                return `<div class="hex-row${offsetClass}">${items}</div>`;
            }).join('');
            
            // Aplicar formas de jaguar únicas y variación de tamaño a cada portada
            applyJaguarSpots();
            
            // Iniciar slideshows en portadas de álbumes
            startAlbumCoverSlideshows(albums);
        }

        // ========== GENERADOR FRACTAL DE MANCHAS DE JAGUAR ==========
        // Genera un clip-path orgánico único para cada celda, simulando las rosetas del jaguar.
        // Cada vez que se invoque (incluso con nuevas galerías), cada portada recibe una forma distinta.
        function generateJaguarSpot(numPoints) {
            numPoints = numPoints || 24;
            const points = [];
            for (let i = 0; i < numPoints; i++) {
                const angle = (2 * Math.PI * i) / numPoints;
                // Radio base elíptico (más alto que ancho, como las celdas del panal)
                const baseRx = 50;
                const baseRy = 50;
                // Perturbación orgánica: usar múltiples frecuencias para efecto fractal
                const noise1 = Math.sin(angle * 3 + Math.random() * 2) * (3 + Math.random() * 5);
                const noise2 = Math.cos(angle * 5 + Math.random() * 3) * (2 + Math.random() * 3);
                const noise3 = Math.sin(angle * 7 + Math.random() * 4) * (1 + Math.random() * 2);
                const r = baseRx + noise1 + noise2 + noise3;
                const ry = baseRy + noise1 * 0.8 - noise2 * 0.6 + noise3 * 1.2;
                const x = 50 + r * Math.cos(angle);
                const y = 50 + ry * Math.sin(angle);
                // Clampear entre 0% y 100%
                points.push(Math.round(Math.max(0, Math.min(100, x))) + '% ' + Math.round(Math.max(0, Math.min(100, y))) + '%');
            }
            return 'polygon(' + points.join(', ') + ')';
        }

        function applyJaguarSpots() {
            const wraps = document.querySelectorAll('.hex-wrap');
            const isMobile = window.innerWidth < 768;
            wraps.forEach(function(wrap) {
                var card = wrap.querySelector('.album-card');
                if (!card) return;
                // Forma única de jaguar
                card.style.clipPath = generateJaguarSpot(22 + Math.floor(Math.random() * 8));
                // Variación real de tamaño: -15% a +15% respecto al tamaño base
                // Esto cambia el ancho efectivo del contenedor para que se note en reposo
                var variation = 0.85 + (Math.random() * 0.30); // 0.85 a 1.15
                if (isMobile) {
                    wrap.style.width = (42 * variation).toFixed(1) + '%';
                } else {
                    wrap.style.width = Math.round(300 * variation) + 'px';
                }
                // Pequeña rotación aleatoria para más organicidad (-3° a +3°)
                var rotation = (Math.random() - 0.5) * 6;
                wrap.style.transform = 'rotate(' + rotation.toFixed(1) + 'deg)';
            });
        }

        // Slideshow en portadas de cada álbum (solo se activa en hover/rollover con crossfade)
        function startAlbumCoverSlideshows(albums) {
            Object.keys(albums).forEach(key => {
                const album = albums[key];
                if (album.photos.length <= 1) return;
                
                let idx = 0;
                const bgEl = document.querySelector(`[data-album-key="${key}"]`);
                if (!bgEl) return;
                const card = bgEl.parentElement;
                
                // Crear segunda capa para crossfade
                const bg2 = document.createElement('div');
                bg2.className = 'album-bg';
                bg2.style.opacity = '0';
                card.insertBefore(bg2, bgEl.nextSibling);
                
                let activeBg = bgEl;
                let inactiveBg = bg2;
                let hoverInterval = null;
                
                // Función de crossfade
                function doCrossfade() {
                    idx = (idx + 1) % album.photos.length;
                    inactiveBg.style.backgroundImage = `url('${album.photos[idx]}')`;
                    inactiveBg.style.transition = 'none';
                    inactiveBg.style.opacity = '0';
                    inactiveBg.offsetHeight; // reflow
                    inactiveBg.style.transition = 'opacity 2s ease-in-out';
                    
                    requestAnimationFrame(() => {
                        requestAnimationFrame(() => {
                            inactiveBg.style.opacity = '1';
                            activeBg.style.opacity = '0';
                        });
                    });
                    
                    // Intercambiar capas
                    [activeBg, inactiveBg] = [inactiveBg, activeBg];
                }
                
                // Solo iniciar rotación al hacer hover (rollover)
                card.addEventListener('mouseenter', () => {
                    // Hacer primer crossfade inmediato al entrar
                    doCrossfade();
                    // Continuar rotando cada 3 segundos mientras se mantiene el hover
                    hoverInterval = setInterval(doCrossfade, 3000);
                });
                
                card.addEventListener('mouseleave', () => {
                    // Detener rotación al salir
                    if (hoverInterval) {
                        clearInterval(hoverInterval);
                        hoverInterval = null;
                    }
                });
            });
        }

        // Abrir álbum en modal
        function openAlbum(albumKey) {
            const albums = getAlbums();
            const album = albums[albumKey];
            if (!album) return;
            
            currentAlbumPhotos = album.photos;
            currentPhotoIndex = 0;
            
            document.getElementById('modal-album-title').textContent = album.name;
            updateModalImage();
            document.getElementById('album-modal').classList.add('active');
            document.body.style.overflow = 'hidden';
            
            // Autoplay cada 5 segundos
            modalAutoplay = setInterval(() => {
                currentPhotoIndex = (currentPhotoIndex + 1) % currentAlbumPhotos.length;
                updateModalImage();
            }, 5000);
        }

        // Actualizar imagen en modal
        function updateModalImage() {
            const img = document.getElementById('modal-image');
            img.style.opacity = '0';
            setTimeout(() => {
                img.src = currentAlbumPhotos[currentPhotoIndex];
                img.onload = () => { img.style.opacity = '1'; };
            }, 300);
            document.getElementById('modal-info').textContent = 
                `${currentPhotoIndex + 1} / ${currentAlbumPhotos.length}`;
        }

        // Navegación del modal
        function nextPhoto() {
            currentPhotoIndex = (currentPhotoIndex + 1) % currentAlbumPhotos.length;
            updateModalImage();
            resetAutoplay();
        }

        function prevPhoto() {
            currentPhotoIndex = (currentPhotoIndex - 1 + currentAlbumPhotos.length) % currentAlbumPhotos.length;
            updateModalImage();
            resetAutoplay();
        }

        function resetAutoplay() {
            if (modalAutoplay) clearInterval(modalAutoplay);
            modalAutoplay = setInterval(() => {
                currentPhotoIndex = (currentPhotoIndex + 1) % currentAlbumPhotos.length;
                updateModalImage();
            }, 5000);
        }

        // Cerrar modal
        function closeAlbumModal() {
            document.getElementById('album-modal').classList.remove('active');
            document.body.style.overflow = '';
            if (modalAutoplay) clearInterval(modalAutoplay);
            modalAutoplay = null;
        }

        // Cerrar modal con Escape o clic fuera
        document.addEventListener('keydown', (e) => {
            if (!document.getElementById('album-modal').classList.contains('active')) return;
            if (e.key === 'Escape') closeAlbumModal();
            if (e.key === 'ArrowRight') nextPhoto();
            if (e.key === 'ArrowLeft') prevPhoto();
        });

        // Extraer nombre de organización de la foto
        function getOrgNameFromPhoto(photoPath) {
            const filename = photoPath.split('/').pop();
            if (filename.includes('CODIGO_ESTILO_CREW')) {
                return 'Código Estilo Crew 2025';
            } else if (filename.includes('THE_GIANT_CORPORATION')) {
                return 'The Giant Corporation 2025';
            } else if (filename.includes('RED_CEPELA')) {
                return 'Red Cepela 2025';
            } else if (filename.includes('CUMBRE_CASA_CULTURAL')) {
                return 'Cumbre Casa Cultural';
            } else if (filename.includes('MALOKA_JOVEN')) {
                return 'Maloka Joven 2025';
            } else if (filename.includes('GUAQUE_SOPO')) {
                return 'Guaque Sopó 2025';
            } else if (filename.includes('ELEMENTS')) {
                return 'Elements 2025';
            } else if (filename.includes('INFLUENCERS_ETNICOS')) {
                return 'Influencers Étnicos 2025';
            }
            return 'Red Intercultural Juvenil';
        }

        // Navegar al mapa desde galería o slideshow
        function goToMapFromGallery(photoPath) {
            const org = getOrgFromPhoto(photoPath);
            
            // Navegar a la sección del mapa
            window.location.hash = '#mapa';
            
            // Scroll suave al mapa
            setTimeout(() => {
                document.getElementById('mapa').scrollIntoView({ behavior: 'smooth' });
                
                // Si encontramos la organización, abrir su popup en el mapa
                if (org && org.lat && org.lng) {
                    setTimeout(() => {
                        // Buscar el marcador correspondiente y hacer zoom
                        if (window.mapInstance) {
                            window.mapInstance.setView([org.lat, org.lng], 12);
                        }
                    }, 500);
                }
            }, 100);
        }

        // Hacer slideshow clicable
        function makeSlideShowClickable() {
            const inicioSection = document.getElementById('inicio');
            inicioSection.style.cursor = 'pointer';
            
            inicioSection.addEventListener('click', (e) => {
                // Solo si se hace clic en el fondo, no en el contenido
                if (e.target === inicioSection || e.target.tagName === 'SECTION') {
                    if (currentPhotoPath) {
                        goToMapFromGallery(currentPhotoPath);
                    }
                }
            });
        }
        function loadAforismos() {
            const track = document.getElementById('marquee-track');
            // Already removed marquee - use flash system instead
            shuffleAforismos();
            // Show first one immediately
            const item = aforismosShuffled[aforismoIndex];
            aforismoIndex++;
            document.getElementById('aforismo-frase').textContent = '\u201c' + item.frase + '\u201d';
            document.getElementById('aforismo-org').textContent = item.org;
            document.getElementById('aforismo-flash').classList.add('visible');

            // Rotate every 5 seconds
            aforismoInterval = setInterval(showNextAforismo, 5000);

            adjustNavPosition();

            // Watch banner for height changes to prevent white gaps
            const bannerObs = document.getElementById('aforismos-banner');
            if (bannerObs && window.ResizeObserver) {
                new ResizeObserver(() => adjustNavPosition()).observe(bannerObs);
            }
        }

        // ========== AFORISMOS FLASH ==========
        let aforismoIndex = 0;
        let aforismosShuffled = [];
        let aforismoInterval = null;

        function shuffleAforismos() {
            aforismosShuffled = [...aforismos];
            for (let i = aforismosShuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [aforismosShuffled[i], aforismosShuffled[j]] = [aforismosShuffled[j], aforismosShuffled[i]];
            }
            aforismoIndex = 0;
        }

        function showNextAforismo() {
            if (aforismoIndex >= aforismosShuffled.length) {
                shuffleAforismos();
            }
            const item = aforismosShuffled[aforismoIndex];
            aforismoIndex++;

            const flashEl = document.getElementById('aforismo-flash');
            const fraseEl = document.getElementById('aforismo-frase');
            const orgEl = document.getElementById('aforismo-org');

            // Fade out
            flashEl.classList.remove('visible');

            setTimeout(() => {
                fraseEl.textContent = '\u201c' + item.frase + '\u201d';
                orgEl.textContent = item.org;
                // Fade in
                flashEl.classList.add('visible');
                // Recalcular posiciones al cambiar contenido del banner
                requestAnimationFrame(adjustNavPosition);
            }, 800);
        }

        function adjustNavPosition() {
            const nav = document.getElementById('main-nav');
            const banner = document.getElementById('aforismos-banner');
            if (nav && banner) {
                const navHeight = nav.offsetHeight;
                banner.style.top = navHeight + 'px';
                const totalFixed = navHeight + banner.offsetHeight;
                document.body.style.paddingTop = totalFixed + 'px';
            }
        }

        // ========== MANIFIESTO AUTO-REVEAL ==========
        function initManifiestoTypewriter() {
            const section = document.getElementById('manifiesto');
            const stickyEl = document.getElementById('manifiesto-sticky');
            const tituloEl = document.getElementById('manifiesto-titulo');
            const cuerpoEl = document.getElementById('manifiesto-cuerpo');

            const tituloText = 'EL RUGIDO';
            const cuerpoText = 'Somos la cosecha del asfalto caliente, la generación que aprendió a florecer justo donde nos dijeron que no crecería nada. Nacimos del estallido, no para quedarnos en el grito, sino para organizar la esperanza y convertir la indignación en estructuras vivas. Desde la profundidad de la selva hasta la esquina del barrio, tejemos una red anfibia que conecta el remedio ancestral con el código urbano, entendiendo que la cultura no es un adorno, sino nuestra herramienta más afilada de defensa personal y colectiva. Aquí declaramos obsoleta la competencia: nuestra única política es la juntanza y nuestra venganza es la vida digna. No pedimos permiso para transformar el territorio; ya lo estamos haciendo, con la certeza de que nuestra rebeldía no es amarga, sino creadora, ruidosa y radicalmente alegre.';

            function wordsToSpans(text) {
                return text.split(/\s+/).map(w => '<span class="mw">' + w + '</span>').join(' ');
            }

            tituloEl.innerHTML = wordsToSpans(tituloText);
            cuerpoEl.innerHTML = wordsToSpans(cuerpoText);

            const allWords = section.querySelectorAll('.mw');
            const totalWords = allWords.length;

            // Posicionar sticky debajo del nav+banner
            function setStickyPosition() {
                const nav = document.getElementById('main-nav');
                const banner = document.getElementById('aforismos-banner');
                const topOffset = (nav ? nav.offsetHeight : 0) + (banner ? banner.offsetHeight : 0);
                stickyEl.style.top = topOffset + 'px';
                stickyEl.style.height = 'calc(100vh - ' + topOffset + 'px)';
            }
            setStickyPosition();

            // Sección solo necesita ~2 viewport heights
            section.style.minHeight = (window.innerHeight * 2.5) + 'px';

            let wordsRevealed = 0;
            let autoRevealInterval = null;
            let autoRevealStarted = false;
            let completed = false;
            const revealSpeed = 80; // ms por palabra

            function revealWord() {
                if (wordsRevealed >= totalWords) {
                    if (autoRevealInterval) {
                        clearInterval(autoRevealInterval);
                        autoRevealInterval = null;
                    }
                    completed = true;
                    return;
                }
                allWords[wordsRevealed].classList.add('vis');
                wordsRevealed++;

                // Auto-scroll del contenedor sticky
                if (stickyEl.scrollHeight > stickyEl.clientHeight) {
                    const lastWord = allWords[wordsRevealed - 1];
                    if (lastWord) {
                        const wordRect = lastWord.getBoundingClientRect();
                        const stickyRect = stickyEl.getBoundingClientRect();
                        const wordRelativeTop = wordRect.top - stickyRect.top + stickyEl.scrollTop;
                        const targetScroll = wordRelativeTop - stickyEl.clientHeight * 0.6;
                        if (targetScroll > 0) {
                            stickyEl.scrollTo({ top: targetScroll, behavior: 'smooth' });
                        }
                    }
                }
            }

            function startAutoReveal() {
                if (autoRevealStarted) return;
                autoRevealStarted = true;
                autoRevealInterval = setInterval(revealWord, revealSpeed);
            }

            function stopAutoReveal() {
                if (autoRevealInterval) {
                    clearInterval(autoRevealInterval);
                    autoRevealInterval = null;
                }
                autoRevealStarted = false;
            }

            function resetAll() {
                stopAutoReveal();
                wordsRevealed = 0;
                completed = false;
                allWords.forEach(w => w.classList.remove('vis'));
                stickyEl.scrollTop = 0;
            }

            function checkVisibility() {
                const rect = section.getBoundingClientRect();
                const vh = window.innerHeight;

                // Si la sección salió completamente del viewport -> resetear
                if (rect.bottom < 0 || rect.top > vh) {
                    if (wordsRevealed > 0) resetAll();
                    return;
                }

                // Trigger: la sección entra en pantalla (top < 2/3 vh)
                if (rect.top < vh * 0.66 && !completed) {
                    startAutoReveal();
                }
            }

            let ticking = false;
            window.addEventListener('scroll', function() {
                if (!ticking) {
                    requestAnimationFrame(function() {
                        checkVisibility();
                        ticking = false;
                    });
                    ticking = true;
                }
            }, { passive: true });

            window.addEventListener('resize', function() {
                setStickyPosition();
                section.style.minHeight = (window.innerHeight * 2.5) + 'px';
            });

            checkVisibility();
        }

        // Cargar directorio
        let currentDirFilter = 'all';
        let currentDirSearch = '';

        function loadDirectorio(orgsToShow) {
            const grid = document.getElementById('directorio-grid');
            const list = (orgsToShow || organizaciones).slice().sort((a, b) => a.nombre.localeCompare(b.nombre, 'es'));
            
            grid.innerHTML = list.map(org => {
                const socials = buildSocialLinks(org);
                
                return `
                <div class="org-card" data-org-id="${org.id}" onclick="toggleOrgCard(this)">
                    <div class="org-card-header">
                        ${org.logo ? `<img src="${org.logo}" alt="${org.nombre}" class="org-logo" onerror="this.style.display='none'">` : '<div class="org-logo bg-white/10 rounded-lg flex items-center justify-center text-xl" style="width:56px;height:56px;">🎨</div>'}
                        <div class="org-card-info">
                            <h3 class="text-white">${org.nombre}</h3>
                            <p class="org-location">${org.municipio}</p>
                            ${socials ? `<div class="org-card-socials">${socials}</div>` : ''}
                        </div>
                        <div class="org-card-toggle">+</div>
                    </div>
                    <div class="org-card-detail">
                        ${org.lema ? `<p class="text-xs italic text-white/40 mb-2">"${org.lema}"</p>` : ''}
                        <div class="text-xs text-white/50 space-y-1">
                            <p><strong class="text-white/70">Contacto:</strong> ${org.representante}</p>
                            <p class="truncate" title="${org.email}"><a href="mailto:${org.email}" class="text-orange-400 hover:text-orange-300 underline" onclick="event.stopPropagation()">${org.email}</a></p>
                            <p><a href="tel:${org.telefono}" class="text-orange-400 hover:text-orange-300 underline" onclick="event.stopPropagation()">${org.telefono}</a></p>
                            ${org.barrio ? `<p class="text-white/40"><strong class="text-white/60">Sede:</strong> ${org.barrio}</p>` : ''}
                            <p class="text-white/40 text-xs">${org.sectores.join(' · ')}</p>
                        </div>
                    </div>
                </div>
            `}).join('');
        }

        function toggleOrgCard(card) {
            card.classList.toggle('expanded');
        }

        function updateDirectorio() {
            let filtered = organizaciones;
            if (currentDirFilter !== 'all') {
                filtered = filtered.filter(o => o.sectores.includes(currentDirFilter) || (currentDirFilter === 'Plástica' && o.sectores.includes('Cerámica')));
            }
            if (currentDirSearch) {
                filtered = filtered.filter(o => 
                    o.nombre.toLowerCase().includes(currentDirSearch) ||
                    (o.nombreCompleto && o.nombreCompleto.toLowerCase().includes(currentDirSearch)) ||
                    o.municipio.toLowerCase().includes(currentDirSearch) ||
                    o.departamento.toLowerCase().includes(currentDirSearch)
                );
            }
            loadDirectorio(filtered);
        }

        function initDirSearchAndFilters() {
            const searchInput = document.getElementById('dir-search');
            const searchResults = document.getElementById('dir-search-results');

            searchInput.addEventListener('input', function() {
                const q = this.value.trim().toLowerCase();
                currentDirSearch = q;
                
                // Autocomplete
                if (q.length >= 1) {
                    const matches = organizaciones.filter(o => 
                        o.nombre.toLowerCase().includes(q) || 
                        (o.nombreCompleto && o.nombreCompleto.toLowerCase().includes(q)) ||
                        o.municipio.toLowerCase().includes(q)
                    );
                    if (matches.length > 0 && matches.length < organizaciones.length) {
                        searchResults.innerHTML = matches.map(o => 
                            '<div class="search-result-item" data-org-id="' + o.id + '"><span class="sr-name">' + o.nombre + '</span><br><span class="sr-loc">' + o.municipio + '</span></div>'
                        ).join('');
                        searchResults.classList.remove('hidden');
                        searchResults.querySelectorAll('.search-result-item').forEach(el => {
                            el.addEventListener('click', function() {
                                const orgId = parseInt(this.dataset.orgId);
                                const org = organizaciones.find(o => o.id === orgId);
                                if (org) {
                                    searchInput.value = org.nombre;
                                    currentDirSearch = org.nombre.toLowerCase();
                                }
                                searchResults.classList.add('hidden');
                                updateDirectorio();
                            });
                        });
                    } else {
                        searchResults.classList.add('hidden');
                    }
                } else {
                    searchResults.classList.add('hidden');
                }
                updateDirectorio();
            });

            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                    searchResults.classList.add('hidden');
                }
            });

            // Filters - toggle behavior
            document.querySelectorAll('#dir-filters .filter-btn-dir').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (this.classList.contains('active')) {
                        // Deselect - show all
                        this.classList.remove('active');
                        currentDirFilter = 'all';
                    } else {
                        document.querySelectorAll('#dir-filters .filter-btn-dir').forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                        currentDirFilter = this.dataset.sector;
                    }
                    updateDirectorio();
                });
            });
        }

        // ========== MARQUEE DE LOGOS EN FOOTER ==========
        function initLogosMarquee() {
            const track = document.getElementById('marquee-track');
            if (!track) return;
            // Recoger logos de organizaciones que tengan logo
            const logos = organizaciones.filter(o => o.logo && o.logo.length > 0).map(o => 
                '<img src="' + o.logo + '" alt="' + o.nombre + '" title="' + o.nombre + '" loading="lazy">'
            );
            // Duplicar para loop continuo
            const allLogos = logos.join('') + logos.join('');
            track.innerHTML = allLogos;
        }

        // Preloader logic — mínimo 5 segundos, espera a que TODO esté cargado
        (function() {
            const preloader = document.getElementById('preloader');
            const preloaderBg = document.getElementById('preloader-bg');
            const bgImages = [
                'assets/backgrownd/01_MAPA_JAGUAR 2.jpg',
                'assets/backgrownd/02_selva.jpg',
                'assets/backgrownd/03_HERO.jpg',
                'assets/backgrownd/04_Jaguar rojo 1.jpg',
                'assets/backgrownd/05_Lomo IMPASTO.jpg'
            ];
            let bgIndex = 0;

            // Set first background immediately
            preloaderBg.style.backgroundImage = 'url("' + bgImages[0] + '")';

            // Rotate backgrounds every 1.5s by hard cut
            const bgInterval = setInterval(function() {
                bgIndex = (bgIndex + 1) % bgImages.length;
                preloaderBg.style.backgroundImage = 'url("' + bgImages[bgIndex] + '")';
            }, 1500);

            const MIN_PRELOAD_MS = 5000;
            const startTime = Date.now();
            let dismissed = false;

            function dismissPreloader() {
                if (dismissed) return;
                dismissed = true;
                clearInterval(bgInterval);
                preloader.classList.add('hide');
                setTimeout(function() {
                    preloader.remove();
                }, 700);
            }

            // Precargar una imagen dada su URL (promesa)
            function preloadSingleImage(src) {
                return new Promise(function(resolve) {
                    const img = new Image();
                    img.onload = resolve;
                    img.onerror = resolve; // no bloquear por errores
                    img.src = src;
                });
            }

            // Recopilar TODAS las URLs de imágenes que necesita la página
            function collectAllImageURLs() {
                var urls = [];
                // 1. Fondos del preloader
                bgImages.forEach(function(u) { urls.push(u); });
                // 2. Fotos de organizaciones (slideshow)
                if (typeof fotosOrgs !== 'undefined') {
                    fotosOrgs.forEach(function(u) { urls.push(u); });
                }
                // 3. Logos de organizaciones desde data.js
                if (typeof organizaciones !== 'undefined') {
                    organizaciones.forEach(function(org) {
                        if (org.logo) urls.push(org.logo);
                    });
                }
                // 4. Logos estáticos de la página (RIJ_SIGLA, RIJ_COMP_NEG, etc.)
                urls.push('assets/logos/RIJ_SIGLA.png');
                urls.push('assets/logos/RIJ_COMP_NEG.png');
                // 5. Todas las <img> ya presentes en el DOM
                document.querySelectorAll('img').forEach(function(img) {
                    if (img.src) urls.push(img.src);
                });
                // Deduplicar
                return urls.filter(function(v, i, a) { return a.indexOf(v) === i; });
            }

            // Promesa del timer mínimo de 5 segundos
            var timerPromise = new Promise(function(resolve) {
                setTimeout(resolve, MIN_PRELOAD_MS);
            });

            // Promesa de window.load (todo el DOM + recursos nativos)
            var windowLoadPromise = new Promise(function(resolve) {
                if (document.readyState === 'complete') {
                    resolve();
                } else {
                    window.addEventListener('load', resolve);
                }
            });

            // Promesa de precarga de TODAS las imágenes recopiladas
            var allImagesPromise = new Promise(function(resolve) {
                // Esperar a que el DOM esté parseado para recopilar URLs
                function go() {
                    var urls = collectAllImageURLs();
                    if (urls.length === 0) { resolve(); return; }
                    Promise.all(urls.map(preloadSingleImage)).then(resolve);
                }
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', go);
                } else {
                    go();
                }
            });

            // Esperar a que TODAS las condiciones se cumplan: timer + window.load + imágenes
            Promise.all([timerPromise, windowLoadPromise, allImagesPromise]).then(dismissPreloader);

            // Seguridad: si después de 15s algo falla, descartar de todas maneras
            setTimeout(function() {
                dismissPreloader();
            }, 15000);
        })();

        // Menu móvil
        document.addEventListener('DOMContentLoaded', function() {
            // Toggle menú móvil
            const menuToggle = document.getElementById('menu-toggle');
            const mobileMenu = document.createElement('div');
            mobileMenu.className = 'hidden md:hidden absolute top-full left-0 right-0 shadow-lg py-4';
            mobileMenu.style.background = 'rgba(255, 107, 53, 0.97)';
            mobileMenu.innerHTML = `
                <ul class="flex flex-col space-y-2 px-4">
                    <li><a href="#inicio" class="block py-2 text-white/85 hover:text-yellow-400">Inicio</a></li>
                    <li><a href="#galeria" class="block py-2 text-white/85 hover:text-yellow-400">Galería</a></li>
                    <li><a href="#manifiesto" class="block py-2 text-white/85 hover:text-yellow-400">Manifiesto</a></li>
                    <li><a href="#mapa" class="block py-2 text-white/85 hover:text-yellow-400">Mapa</a></li>
                    <li><a href="#directorio" class="block py-2 text-white/85 hover:text-yellow-400">Directorio</a></li>
                    <li><a href="#articulaciones" class="block py-2 text-white/85 hover:text-yellow-400">Articulaciones</a></li>
                    <li><a href="#salvaguarda" class="block py-2 text-white/85 hover:text-yellow-400">Salvaguarda</a></li>
                    <li><a href="#envolvente" class="block py-2 text-white/85 hover:text-yellow-400">Envolvente</a></li>
                    <li><a href="#contacto" class="block py-2 text-white/85 hover:text-yellow-400">Contacto</a></li>
                </ul>
            `;
            
            menuToggle.parentElement.appendChild(mobileMenu);
            
            menuToggle.addEventListener('click', function() {
                mobileMenu.classList.toggle('hidden');
            });
            
            // Cerrar menú al hacer clic en un enlace
            mobileMenu.querySelectorAll('a').forEach(link => {
                link.addEventListener('click', () => {
                    mobileMenu.classList.add('hidden');
                });
            });
            
            // Inicializar todo
            createShuffle();
            
            // Mostrar primera foto inmediatamente
            setRandomBackground(false);
            
            // Precargar el resto y empezar rotación
            preloadImages().then(() => {
                startPhotoRotation();
            });
            
            makeSlideShowClickable();
            loadAforismos();
            loadGallery();
            loadDirectorio();
            initDirSearchAndFilters();
            initMap();
            initManifiestoTypewriter();
            initLogosMarquee();

            // Reajustar posiciones en resize
            window.addEventListener('resize', adjustNavPosition);
            
            // Reconstruir galería al cruzar el breakpoint móvil/desktop
            let galleryResizeTimer;
            window.addEventListener('resize', function() {
                clearTimeout(galleryResizeTimer);
                galleryResizeTimer = setTimeout(function() {
                    const currentMode = window.innerWidth < 768 ? 'mobile' : 'desktop';
                    if (currentMode !== lastGalleryMode) {
                        lastGalleryMode = null;
                        loadGallery();
                    }
                }, 250);
            });
        });
    </script>
</body>
</html>
